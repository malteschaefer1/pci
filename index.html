<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PCI Circularity Calculator</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
    <script src="assets/js/circularity.js" defer></script>
    <script src="assets/js/csv-utils.js" defer></script>
    <script src="assets/js/charts.js" defer></script>
    <script src="assets/js/app.js" defer></script>
  </head>
  <body>
    <noscript>
      <div class="noscript-warning">
        This tool requires JavaScript. Please enable it to calculate circularity indicators.
      </div>
    </noscript>
    <!-- ===== Hero / Intro header ===== -->
    <header class="page-header">
      <div>
        <p class="eyebrow">Product Circularity assistant</p>
        <h1>PCI Circularity Calculator</h1>
        <summary>
          Estimate Product Circularity Indicator (PCI), Component Circularity Indicator (CCI), and Circularity Impact Indicator (CII)
          directly in your browser. Upload CSV files or edit data inline, then visualize the results per Appendix A of the PCI paper.
        </summary>
        <p class="subtitle">
          Authors: Jacqueline Müller · Malte Schäfer · Mathis auf dem Graben · Tim Katzwinkel · Manuel Löwer
        </p>
        <p class="disclaimer">
          ⚠️ Work in progress: this tool evolves alongside the PCI methodology. Please validate results before relying on them in
          production workflows.
        </p>
        <div class="link-row">
          <a href="PCI_paper_V2.pdf" target="_blank" rel="noopener">Open PCI methodology (PDF)</a>
          <span aria-hidden="true">•</span>
          <a href="README.html" target="_blank" rel="noopener">Open project README file</a>
          <span aria-hidden="true">•</span>
          <a href="https://github.com/malteschaefer1/pci" target="_blank" rel="noopener">View source on GitHub</a>
        </div>
      </div>
    </header>

    <main>
      <!-- ===== Step-by-step explainer ===== -->
      <section id="intro" class="card">
        <h2>How it works</h2>
        <p>
          Follow the numbered steps below: set product-level parameters (<a href="#product-params">Step 1</a>), load or enter component
          data (<a href="#data-entry">Step 2</a>), compute indicators (<a href="#calculation">Step 3</a>), review charts
          (<a href="#visualizations">Step 4</a>), and export your results (<a href="#export">Step 5</a>). All logic follows Sections 3–4
          and Appendix A of the accompanying paper.
        </p>
        <p>
          The diagram below summarizes the material and information flows tracked by the calculator: virgin feedstock, recycled inputs,
          reused components, and the linear losses that ultimately drive PCI, CCI, and CII.
        </p>
        <figure style="max-width:640px;margin:1.5rem auto;text-align:center;">
          <a href="examples/flowchart_generic.png" target="_blank" rel="noopener">
            <img
              src="examples/flowchart_generic.png"
              alt="Flowchart showing virgin, recycled, and reused streams feeding the PCI equations"
              style="width:100%;height:auto;display:block;margin:0 auto;border:1px solid #e0e0e0;border-radius:6px;background:#fff;"
            />
          </a>
          <figcaption style="margin-top:0.5rem;color:#555;font-style:italic;">
            Generic flowchart showcasing the PCI variables, flows, and system boundary (adapted from <a href="https://doi.org/10.1016/j.resconrec.2019.104608" target="_blank" rel="noopener">Braquené et al.</a> - click to enlarge).
          </figcaption>
        </figure>
        <p>
          Tool features:
        </p>
        <ul>
          <li>Pure client-side app – simply open <code>index.html</code> (this page).</li>
          <li>
            Upload your own CSVs or use the templates provided here (<a href="#data-entry">Step 2</a>).
          </li>
          <li>
            Visual outputs powered by Chart.js; CSV parsing handled by
            <a href="https://www.papaparse.com" target="_blank" rel="noopener">Papa Parse</a>.
          </li>
        </ul>
      </section>

      <!-- ===== Async status banner ===== -->
      <section id="status-panel" class="status-panel" aria-live="polite">
        <span class="status-panel__title">Status</span>
        <span id="status-message">Ready for input.</span>
      </section>

      <!-- ===== Step 1: Product parameters ===== -->
      <section id="product-params" class="card">
        <div class="section-header">
          <h2>Step 1 – Product parameters</h2>
          <p>Provide high-level parameters that apply to every component of this product.</p>
          <button type="button" id="reset-product-params" class="secondary">Reset product parameters</button>
        </div>
        <form id="product-form" class="grid two-col">
          <label
            class="field"
            title="Section 3.1 of the PCI paper describes naming the assessed product so stakeholders can reference it consistently."
          >
            <span
              class="field-title"
              title="Give the assessed product a recognizable name – Section 3.1 calls this the product under study."
              >Product name</span
            >
            <span
              class="field-summary"
              title="Use the internal product label or scenario description so the result tables and exports stay readable."
              >Short label shown in summary cards, tables, and CSV exports.</span
            >
            <input
              type="text"
              name="productName"
              placeholder="e.g., Guard Lock Switch"
              data-validate="text"
              title="Letters, numbers, spaces, parentheses, and hyphens are accepted. Avoid quotes or emoji."
            />
            <span class="field-feedback" aria-live="polite"></span>
          </label>

          <label
            class="field"
            title="Fu (Section 3.2 / Appendix A) captures how many components are reused when assembling the current product. Source: refurbishment or remanufacturing records."
          >
            <span
              class="field-title"
              title="Pull Fu from refurbishment or remanufacturing data per Section 3.2."
              >F<sub>u</sub> – Reused component share</span
            >
            <span
              class="field-summary"
              title="Use procurement or service data to estimate how many components are reused directly."
              >Percent of components that enter the BoM as reused items.</span
            >
            <input
              type="number"
              name="Fu"
              min="0"
              max="100"
              step="0.1"
              value="0"
              placeholder="0.0 - 100.0"
              data-validate="percentage"
              title="Enter a percentage between 0 and 100. Use digits and decimal points only."
            />
            <span class="field-feedback" aria-live="polite"></span>
          </label>

          <label
            class="field"
            title="Cu (Section 3.2 / Appendix A) is the reusable share after end-of-life collection. Source: reverse-logistics studies or assumptions."
          >
            <span class="field-title" title="Cu from Section 3.2 describes how much can be reused after collection."
              >C<sub>u</sub> – Reusable share at end-of-life</span
            >
            <span
              class="field-summary"
              title="Use collection trials, eco-design studies, or literature to estimate the reusable mass share."
              >Percent of the collected product that can be reused without reprocessing.</span
            >
            <input
              type="number"
              name="Cu"
              min="0"
              max="100"
              step="0.1"
              value="60"
              placeholder="0.0 - 100.0"
              data-validate="percentage"
              title="Enter a percentage between 0 and 100. Use digits and decimal points only."
            />
            <span class="field-feedback" aria-live="polite"></span>
          </label>

          <label
            class="field"
            title="Cr (Section 3.2 / Appendix A) is the recyclable share after end-of-life processing. Source: recycling partner data, literature, or regulatory targets."
          >
            <span class="field-title" title="Cr quantifies the share that actually gets recycled per Section 3.2."
              >C<sub>r</sub> – Recyclable share at end-of-life</span
            >
            <span
              class="field-summary"
              title="Estimate using waste-management provider data or regional take-back statistics."
              >Percent of the collected product that proceeds to material recycling.</span
            >
            <input
              type="number"
              name="Cr"
              min="0"
              max="100"
              step="0.1"
              value="56"
              placeholder="0.0 - 100.0"
              data-validate="percentage"
              title="Enter a percentage between 0 and 100. Use digits and decimal points only."
            />
            <span class="field-feedback" aria-live="polite"></span>
          </label>

          <label
            class="field"
            title="Ld (Section 3.2 / Appendix A) is the expected lifetime or duty cycles taken from standards or design requirements."
          >
            <span class="field-title" title="Ld is the baseline lifetime from standards or specs.">L<sub>d</sub> – Expected lifetime</span>
            <span
              class="field-summary"
              title="Use industry standards or design requirements for the baseline lifetime."
              >Reference service life (years, months etc.) used in the use-factor denominator.</span
            >
            <input
              type="number"
              name="Ld"
              min="0.01"
              step="0.01"
              value="1"
              placeholder="e.g. 1.0"
              data-validate="positive"
              title="Enter a positive number using digits and decimal points (same unit as L)."
            />
            <span class="field-feedback" aria-live="polite"></span>
          </label>

          <label
            class="field"
            title="L (Section 3.2 / Appendix A) is the actual or scenario-specific lifetime observed for the product."
          >
            <span class="field-title" title="L is the realized service life for the assessed product.">L – Actual lifetime</span>
            <span
              class="field-summary"
              title="Use measured field data, warranty information, or the scenario definition."
              >Observed lifetime in the same unit as L<sub>d</sub>.</span
            >
            <input
              type="number"
              name="L"
              min="0.01"
              step="0.01"
              value="1"
              placeholder="e.g. 1.0"
              data-validate="positive"
              title="Enter a positive number using digits and decimal points (same unit as Ld)."
            />
            <span class="field-feedback" aria-live="polite"></span>
          </label>

          <label
            class="field"
            title="Id (Section 3.2 / Appendix A) is the expected use intensity, such as duty cycles per year, taken from specifications."
          >
            <span class="field-title" title="Id is the baseline use intensity from specifications.">I<sub>d</sub> – Expected use intensity</span>
            <span
              class="field-summary"
              title="Reference how often the product is expected to be used per functional unit."
              >Baseline usage rate (cycles, hours, etc.) for the denominator.</span
            >
            <input
              type="number"
              name="Id"
              min="0.01"
              step="0.01"
              value="1"
              placeholder="e.g. 1.0"
              data-validate="positive"
              title="Enter a positive number using digits and decimal points (same unit as I)."
            />
            <span class="field-feedback" aria-live="polite"></span>
          </label>

          <label
            class="field"
            title="I (Section 3.2 / Appendix A) is the actual use intensity observed for the assessed product."
          >
            <span class="field-title" title="I is the realized use intensity for the assessed functional unit.">I – Actual use intensity</span>
            <span
              class="field-summary"
              title="Use telemetry, service data, or scenario assumptions for actual usage."
              >Measured usage rate in the same unit as I<sub>d</sub>.</span
            >
            <input
              type="number"
              name="I"
              min="0.01"
              step="0.01"
              value="1"
              placeholder="e.g. 1.0"
              data-validate="positive"
              title="Enter a positive number using digits and decimal points (same unit as Id)."
            />
            <span class="field-feedback" aria-live="polite"></span>
          </label>

          <p class="helper-text">
            Tip: when L = L<sub>d</sub> and I = I<sub>d</sub> the use factor X (Eq. 8) equals 1, so indicator changes stem purely from linear
            flows.
          </p>
        </form>
      </section>

      <!-- ===== Step 2: Data entry (CSV & Manual) ===== -->
      <section id="data-entry" class="card">
        <div class="section-header">
          <h2>Step 2 – Bill of Materials &amp; input factors</h2>
          <p>Upload CSV files or edit the table manually. Percent inputs expect values between 0 and 100.</p>
          <div class="parameter-glossary">
            <h3>Key input factors</h3>
            <ul>
              <li title="Section 3.2 / Appendix A: Fraction of recycled content entering feedstock production. Gather from supplier LCI data or recycling agreements.">
                <strong>F<sub>r</sub></strong> – Recycling share in feedstock production.
              </li>
              <li title="Section 3.2 / Appendix A: Mass efficiency of feedstock production (usable output vs. total input). Source from process engineers or LCI databases.">
                <strong>E<sub>fp</sub></strong> – Efficiency of feedstock production.
              </li>
              <li title="Section 3.2 / Appendix A: Mass efficiency of component production (net part vs. input). Obtain from manufacturing KPIs or MES data.">
                <strong>E<sub>cp</sub></strong> – Efficiency of component production.
              </li>
              <li title="Section 3.2 / Appendix A: Fraction of feedstock-production losses that are looped back into feedstock. Check scrap management contracts.">
                <strong>C<sub>fp</sub></strong> – Share of feedstock-production losses recycled.
              </li>
              <li title="Section 3.2 / Appendix A: Fraction of component-production losses that are recycled internally. Source from shop-floor scrap reports.">
                <strong>C<sub>cp</sub></strong> – Share of component-production losses recycled.
              </li>
              <li title="Section 3.2 / Appendix A: Efficiency of the material-separation step at end of life. Use dismantling studies or recycler specifications.">
                <strong>E<sub>ms</sub></strong> – Efficiency of material separation.
              </li>
              <li title="Section 3.2 / Appendix A: Efficiency of recycling material back into new feedstock. Use recycler yield data or literature values.">
                <strong>E<sub>rfp</sub></strong> – Efficiency of recycling into new feedstock.
              </li>
            </ul>
          </div>
        </div>
        <div class="tabs">
          <div class="tab-buttons" role="tablist">
            <button type="button" class="tab-button active" data-tab="csv" role="tab" aria-selected="true">CSV mode</button>
            <button type="button" class="tab-button" data-tab="manual" role="tab" aria-selected="false">Manual mode</button>
          </div>
          <div class="tab-panel" data-tab-panel="csv" role="tabpanel">
            <div class="grid two-col">
              <div>
                <h3>CSV templates</h3>
                <p>Download fresh templates whenever you need a clean starting point.</p>
                <div class="button-row">
                  <button type="button" class="secondary" data-download="bom">Download BoM template (CSV)</button>
                  <button type="button" class="secondary" data-download="factors">Download input-factors template (CSV)</button>
                </div>
                <p class="helper-text">
                  Want to explore the case-study data from PCI_paper_V2? Load the ready-made CSVs under <code>/examples</code> (for
                  instance <code>examples/bom_case_study.csv</code> and <code>examples/input_factors_case_study.csv</code>) via the
                  upload buttons on the right.
                </p>
              </div>
              <div>
                <h3>Upload filled CSVs</h3>
                <label class="file-control">
                  Upload BoM CSV
                  <input type="file" id="bom-upload" accept=".csv" />
                </label>
                <label class="file-control">
                  Upload input-factors CSV
                  <input type="file" id="factors-upload" accept=".csv" />
                </label>
                <p class="helper-text">
                  After upload, the editable table in Manual mode reflects the parsed data so you can fine-tune the numbers.
                </p>
              </div>
            </div>
          </div>
          <div class="tab-panel hidden" data-tab-panel="manual" role="tabpanel">
            <div class="manual-grid">
              <article class="manual-card">
                <div class="manual-card__header">
                  <div>
                    <h3>Manual BoM entry</h3>
                    <p>See Table 4 in the paper: by listing each part, its material, mass, and primary process.</p>
                  </div>
                  <button type="button" id="bom-add-row" class="icon-button" aria-label="Add BoM row">
                    <span aria-hidden="true">＋</span> Add row
                  </button>
                </div>
                <div class="table-wrapper compact">
                  <table aria-label="Manual BoM entry table">
                    <thead>
                      <tr>
                        <th>Part ID</th>
                        <th>Part name</th>
                        <th>Material</th>
                        <th>Mass [kg]</th>
                        <th>Process</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="manual-bom-body"></tbody>
                  </table>
                  <datalist id="bom-suggest-part"></datalist>
                  <datalist id="bom-suggest-name"></datalist>
                  <datalist id="bom-suggest-material"></datalist>
                  <datalist id="bom-suggest-mass"></datalist>
                  <datalist id="bom-suggest-process"></datalist>
                </div>
                <p class="helper-text">
                  Component IDs must be unique. Part names, materials, and processes may repeat (e.g., two IDs can reference the same
                  material/process combination).
                </p>
                <div class="manual-actions">
                  <button type="button" id="bom-complete">BoM complete</button>
                </div>
              </article>

              <article class="manual-card" id="manual-factors-card" hidden>
                <div class="manual-card__header">
                  <div>
                    <h3>Manual input factors</h3>
                    <p>See Table 5 in the paper: capture recycling shares for each material &amp; process combination.</p>
                  </div>
                  <button type="button" id="factors-add-row" class="icon-button" aria-label="Add factor row">
                    <span aria-hidden="true">＋</span> Add row
                  </button>
                </div>
                <div class="table-wrapper compact">
                  <table aria-label="Manual input factors entry table">
                    <thead>
                      <tr>
                        <th>Material</th>
                        <th>Process</th>
                        <th>F<sub>r</sub> [%]</th>
                        <th>E<sub>fp</sub> [%]</th>
                        <th>E<sub>cp</sub> [%]</th>
                        <th>C<sub>fp</sub> [%]</th>
                        <th>C<sub>cp</sub> [%]</th>
                        <th>E<sub>ms</sub> [%]</th>
                        <th>E<sub>rfp</sub> [%]</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="manual-factor-body"></tbody>
                  </table>
                </div>
                <div class="manual-actions">
                  <button type="button" id="factors-complete">Input factors complete</button>
                </div>
              </article>
              <div class="manual-placeholder" id="manual-factors-placeholder">
                Click “BoM complete” to auto-generate material/process combinations for input factors.
              </div>
            </div>

            <div class="manual-editor" id="manual-editor-card" hidden>
              <div class="manual-editor__header">
                <div>
                  <h3>Component parameter editor</h3>
                  <p>
                    Once the BoM and input factors are confirmed, this table is auto-populated for advanced adjustments (E<sub>fp</sub>,
                    E<sub>cp</sub>, C<sub>fp</sub>, etc.).
                  </p>
                </div>
                <div class="table-actions">
                  <div>
                    <button type="button" id="add-row">Add component</button>
                    <button type="button" id="reset-example" class="secondary">Reset to example data</button>
                  </div>
                  <p class="helper-text">
                    Columns F<sub>r</sub>–E<sub>rfp</sub> are entered as percentages. Invalid cells are highlighted automatically.
                  </p>
                </div>
              </div>
              <div class="table-wrapper">
                <table aria-label="Component inputs">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Material</th>
                      <th>Process</th>
                      <th>Mass [kg]</th>
                      <th>F<sub>r</sub> [%]</th>
                      <th>E<sub>fp</sub> [%]</th>
                      <th>E<sub>cp</sub> [%]</th>
                      <th>C<sub>fp</sub> [%]</th>
                      <th>C<sub>cp</sub> [%]</th>
                      <th>E<sub>ms</sub> [%]</th>
                      <th>E<sub>rfp</sub> [%]</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="components-table-body"></tbody>
                </table>
              </div>
            </div>
            <div class="manual-placeholder" id="manual-editor-placeholder">
              Complete the BoM and input factors to enable the component parameter editor.
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Step 3: Calculation ===== -->
      <section id="calculation" class="card">
        <div class="section-header">
          <h2>Step 3 – Calculate PCI, CCI &amp; CII</h2>
          <p>All formulas reference Appendix A (Eq. 3–23). Make sure each component has complete data before running.</p>
        </div>
        <div class="calculate-row">
          <button type="button" id="compute-btn">Compute circularity indicators</button>
          <div>
            <p class="helper-text">
              PCI refers to the whole product (0...1), CCI (0...1) and CII (0...100 %) to individual components.
            </p>
          </div>
        </div>
        <div id="results" class="results hidden">
          <div class="pci-summary">
            <div>
              <p class="label">Product name</p>
              <p id="product-name-display" class="value">–</p>
            </div>
            <div>
              <p class="label">Total mass</p>
              <p id="total-mass" class="value">– kg</p>
              <p class="subvalue">Virgin feedstock mass (V) - lower is better: <span id="total-virgin">– kg</span></p>
              <p class="subvalue">Unrecoverable waste mass (W) - lower is better: <span id="total-waste">– kg</span></p>
            </div>
          </div>
          <div class="metric-grid">
            <div class="metric-meter">
              <div class="metric-meter__header">
                <span>Product use factor (X) - higher is better</span>
                <strong id="use-factor-value">–</strong>
              </div>
              <div class="metric-meter__bar">
                <div id="use-factor-bar"></div>
              </div>
            </div>
            <div class="metric-meter">
              <div class="metric-meter__header">
                <span>Linear Flow Index (LFI) - lower is better</span>
                <strong id="lfi-value">–</strong>
              </div>
              <div class="metric-meter__bar">
                <div id="lfi-bar"></div>
              </div>
            </div>
          </div>
          <div class="pci-meter">
            <div class="pci-meter__header">
              <span>Product Circularity Indicator (PCI) - higher is better</span>
              <strong id="pci-value">–</strong>
            </div>
            <div class="pci-meter__bar">
              <div id="pci-bar" style="width: 0%"></div>
            </div>
          </div>
          <div class="table-wrapper">
            <table aria-label="Component results">
              <thead>
                <tr>
                  <th>Signature</th>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Mass [kg]</th>
                  <th>Material</th>
                  <th>Process</th>
                  <th>CCI</th>
                  <th>CII [%]</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="results-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ===== Step 4: Visualizations ===== -->
      <section id="visualizations" class="card">
        <div class="section-header">
          <h2>Step 4 – Visualize the results</h2>
          <p>Columns reflect the Component Circularity Indicator (CCI, left) and Circularity Impact Indicator (CII, right). The CCI reflects the degree of circularity of each component, and the CII the contribution of each component to the overall product circularity (PCI). Charts refresh every time you recompute, and the stacked chart below compares how each component contributes to mass and CII shares.</p>
        </div>
        <div class="grid two-col chart-grid">
          <div>
            <div class="chart-header">
              <h3>CCI by component</h3>
              <button type="button" id="sort-cci" class="secondary">Sort high → low</button>
            </div>
            <canvas id="cci-chart" height="200"></canvas>
          </div>
          <div>
            <div class="chart-header">
              <h3>CII by component</h3>
              <button type="button" id="sort-cii" class="secondary">Sort high → low</button>
            </div>
            <canvas id="cii-chart" height="200"></canvas>
          </div>
        </div>
        <div class="chart-wide">
          <div class="chart-header">
            <h3>Relative mass and CII share of each component</h3>
            <div class="chart-header__actions">
              <button type="button" id="sort-composition-mass" class="secondary">Sort by mass share (high → low)</button>
              <button type="button" id="sort-composition-cii" class="secondary">Sort by CII share (high → low)</button>
              <button type="button" id="sort-composition-reset" class="secondary">Reset order</button>
            </div>
          </div>
          <canvas id="composition-chart" height="260"></canvas>
        </div>
      </section>

      <!-- ===== Step 5: Export ===== -->
      <section id="export" class="card">
        <div class="section-header">
          <h2>Step 5 – Export data</h2>
          <p>Download your working tables or share calculated outputs.</p>
        </div>
        <div class="export-settings">
          <label>
            Decimal separator
            <select id="decimal-separator">
              <option value="dot" selected>Dot (.)</option>
              <option value="comma">Comma (,)</option>
            </select>
          </label>
          <p class="helper-text">
            CSV exports will use the selected separator for numeric values. Choose “Comma” if your spreadsheet locale expects
            decimals as 0,160 instead of 0.160.
          </p>
        </div>
        <div class="button-row">
          <button type="button" data-export="bom" class="secondary">Download current BoM CSV</button>
          <button type="button" data-export="factors" class="secondary">Download current input-factors CSV</button>
          <button type="button" data-export="results" class="secondary">Download results CSV</button>
        </div>
        <p class="helper-text">
          CSV exports include everything currently shown in the Manual mode table. The results CSV adds LFI, CCI, and CII per component.
        </p>
      </section>
    </main>

    <footer class="page-footer">
      <p>
        Built with vanilla HTML/CSS/JS. Logic references
        <a href="PCI_paper_V2.pdf" target="_blank" rel="noopener">PCI methodology paper</a>. Licensed under the
        <a href="LICENSE" target="_blank" rel="noopener">MIT License</a>.
      </p>
    </footer>
  </body>
</html>
